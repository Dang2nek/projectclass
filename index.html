<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Class login portal</title>
<style>
  body {
    background: radial-gradient(circle at center, #200 0%, #000 100%);
    color: white;
    font-family: 'Segoe UI', sans-serif;
    text-align: center;
    overflow: hidden;
  }
  h1 { margin-top: 100px; font-size: 3em; text-shadow: 0 0 20px red; }
  button {
    background: red; border: none; padding: 15px 30px;
    color: white; font-size: 1.2em; border-radius: 12px;
    cursor: pointer; transition: all .3s;
  }
  button:hover { box-shadow: 0 0 15px red; transform: scale(1.05); }
  #error { color: #ff8080; margin-top: 20px; font-size: 1.1em; }

  /* popup nhập mã */
  #secretInput, #teacherCodeInput {
    display: none; position: fixed; top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(0,0,0,0.9); padding: 30px; border-radius: 12px;
    box-shadow: 0 0 20px red; z-index: 9999;
  }
  input {
    padding: 10px; border-radius: 8px; border: none; width: 80%;
    margin-bottom: 10px; text-align: center;
  }
  #glitch {
    position: fixed; inset: 0; background: red;
    mix-blend-mode: screen; opacity: 0; pointer-events: none;
    animation: none;
  }
  @keyframes glitch {
    0%,100% {opacity: 0;}
    10%,30%,50%,70%,90% {opacity: .5; transform: translateX(-5px);}
    20%,40%,60%,80% {opacity: .5; transform: translateX(5px);}
  }
</style>
</head>
<body>
  <h1>Welcome to C00lKID GUI</h1>
  <button id="googleLogin">Class Login</button>
  <div id="error"></div>

  <!-- popup nhập mã ẩn -->
  <div id="secretInput">
    <h2>Nhập mã truy cập</h2>
    <input type="password" id="secretCode" placeholder="Nhập mã...">
    <br><button onclick="checkSecret()">OK</button>
  </div>

  <!-- popup nhập mã giáo viên -->
  <div id="teacherCodeInput">
    <h2>Hãy nhập mã giáo viên<br><small>(Bỏ trống nếu là học sinh)</small></h2>
    <input type="password" id="teacherCode" placeholder="Mã giáo viên...">
    <br><button onclick="saveTeacherCode()">Xác nhận</button>
  </div>

  <div id="glitch"></div>
  <audio id="evilLaugh" src="https://files.catbox.moe/z9v5ho.mp3"></audio>

  <!-- Firebase v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyANHvtLT4TpJW9C6qhmNdiIGYcbe5th_Yw",
      authDomain: "classweb-11389.firebaseapp.com",
      projectId: "classweb-11389",
      storageBucket: "classweb-11389.firebasestorage.app",
      messagingSenderId: "91367336185",
      appId: "1:91367336185:web:30a78cfe10e459b0605a28",
      measurementId: "G-7123YZQKWV"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    const errorDiv = document.getElementById("error");
    const teacherPopup = document.getElementById("teacherCodeInput");
    const glitch = document.getElementById("glitch");
    const laugh = document.getElementById("evilLaugh");

    document.getElementById("googleLogin").onclick = googleLogin;

    async function googleLogin() {
      const provider = new firebase.auth.GoogleAuthProvider();
      try {
        const result = await auth.signInWithPopup(provider);
        const user = result.user;
        const name = user.displayName;

        const teacherDoc = await db.collection("teachers").doc(name).get();
        const studentDoc = await db.collection("students").doc(name).get();

        if (!teacherDoc.exists && !studentDoc.exists) {
          teacherPopup.style.display = "block"; // hỏi mã nếu lần đầu
        } else {
          redirectBasedOnRole(teacherDoc.exists);
        }
      } catch (e) {
        console.error(e);
        errorDiv.textContent = "Đăng nhập thất bại!";
      }
    }

    async function saveTeacherCode() {
      const user = auth.currentUser;
      const name = user.displayName;
      const code = document.getElementById("teacherCode").value.trim();

      try {
        if (code === "") {
          await db.collection("students").doc(name).set({ name, role: "student" });
          redirectBasedOnRole(false);
        } else {
          await db.collection("teachers").doc(name).set({ name, role: "teacher", code });
          redirectBasedOnRole(true);
        }
      } catch (e) {
        console.error(e);
        errorDiv.textContent = "Lỗi lưu thông tin người dùng!";
      }
    }

    function redirectBasedOnRole(isTeacher) {
      const dest = isTeacher
        ? "https://classwebteacher.onrender.com/"
        : "https://classwebstudent.onrender.com/";
      window.location.href = dest;
    }

    // Ẩn mã: Ctrl+M hoặc click 3 lần
    let clickCount = 0;
    const classBtn = document.getElementById("googleLogin");
    classBtn.addEventListener("click", () => {
      clickCount++;
      if (clickCount >= 3) {
        document.getElementById("secretInput").style.display = "block";
        clickCount = 0;
      }
      setTimeout(() => (clickCount = 0), 2000);
    });

    document.addEventListener("keydown", e => {
      if (e.ctrlKey && e.key.toLowerCase() === "m") {
        document.getElementById("secretInput").style.display = "block";
      }
    });

    // Kiểm tra mã ẩn
    function checkSecret() {
      const code = document.getElementById("secretCode").value.trim();
      if (code === "C00lKID") {
        document.getElementById("secretInput").style.display = "none";
        startGlitch();
        setTimeout(() => {
          window.location.href = "https://c00lkidgui.onrender.com/";
        }, 4000);
      } else {
        alert("Sai mã!");
      }
    }

    function startGlitch() {
      glitch.style.animation = "glitch 0.1s infinite";
      laugh.play();
    }
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Class Web</title>
<style>
  body { font-family: sans-serif; background: #111; color: #fff; text-align:center; padding:20px; }
  #login, #teacherPanel, #studentPanel { display:none; }
  input { padding:5px; margin:5px; }
  button { padding:5px 10px; margin:5px; cursor:pointer; }
  #tunnel { position:fixed; top:0; left:0; width:100%; height:100%; background:black; z-index:1000; display:none; }
  #tunnel div { width:10px; height:10px; border-radius:50%; background:cyan; position:absolute; animation:tunnelAnim 1s linear infinite; }
  @keyframes tunnelAnim { from {transform:scale(0) translateZ(0);} to {transform:scale(20) translateZ(500px);} }
</style>
</head>
<body>

<h1>Class Web</h1>

<div id="login">
  <h2>Login</h2>
  <input type="email" id="email" placeholder="Email"><br>
  <input type="password" id="password" placeholder="Password"><br>
  <select id="role">
    <option value="student">Student</option>
    <option value="teacher">Teacher</option>
  </select><br>
  <button onclick="loginUser()">Login / Register</button>
</div>

<div id="teacherPanel">
  <h2>Teacher Panel</h2>
  <input type="text" id="taskTitle" placeholder="Task Title">
  <input type="text" id="taskDesc" placeholder="Task Description">
  <button onclick="addTask()">Add Task</button>
  <h3>Tasks:</h3>
  <ul id="taskList"></ul>
</div>

<div id="studentPanel">
  <h2>Student Panel</h2>
  <h3>Tasks:</h3>
  <ul id="taskListStudent"></ul>
</div>

<div id="tunnel"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.24.0/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/9.24.0/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, collection, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/9.24.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyANHvtLT4TpJW9C6qhmNdiIGYcbe5th_Yw",
  authDomain: "classweb-11389.firebaseapp.com",
  projectId: "classweb-11389",
  storageBucket: "classweb-11389.appspot.com",
  messagingSenderId: "91367336185",
  appId: "1:91367336185:web:30a78cfe10e459b0605a28"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth();
const db = getFirestore();

document.getElementById('login').style.display = 'block';

async function loginUser() {
  const email = document.getElementById('email').value;
  const password = document.getElementById('password').value;
  const role = document.getElementById('role').value;

  let user;
  try {
    const userCredential = await signInWithEmailAndPassword(auth, email, password);
    user = userCredential.user;
  } catch (e) {
    // Nếu không tồn tại thì tạo
    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
    user = userCredential.user;
  }

  // Tạo doc lần đầu
  const col = role === "teacher" ? "teachers" : "students";
  const userDocRef = doc(db, col, user.uid);
  const userDoc = await getDoc(userDocRef);
  if (!userDoc.exists()) {
    await setDoc(userDocRef, { name: email.split('@')[0], role, createdAt: new Date() });
  }

  // Hiệu ứng tunnel trước khi chuyển panel
  showTunnel(role);
}

function showTunnel(role) {
  const tunnel = document.getElementById('tunnel');
  tunnel.style.display = 'block';
  for(let i=0;i<50;i++){
    const dot = document.createElement('div');
    dot.style.top = Math.random()*100 + '%';
    dot.style.left = Math.random()*100 + '%';
    dot.style.animationDelay = Math.random()+'s';
    tunnel.appendChild(dot);
  }
  setTimeout(()=>{
    tunnel.innerHTML='';
    tunnel.style.display='none';
    if(role==='teacher'){
      document.getElementById('login').style.display='none';
      document.getElementById('teacherPanel').style.display='block';
      loadTasks('teacher');
    } else {
      document.getElementById('login').style.display='none';
      document.getElementById('studentPanel').style.display='block';
      loadTasks('student');
    }
  },1500);
}

async function addTask() {
  const title = document.getElementById('taskTitle').value;
  const desc = document.getElementById('taskDesc').value;
  const user = auth.currentUser;
  if(!user) return;
  await addDoc(collection(db, "tasks"), { title, description: desc, createdBy: user.uid, createdAt: new Date() });
  loadTasks('teacher');
}

async function loadTasks(role){
  const taskList = role==='teacher' ? document.getElementById('taskList') : document.getElementById('taskListStudent');
  taskList.innerHTML='';
  const querySnapshot = await getDocs(collection(db, "tasks"));
  querySnapshot.forEach(docSnap=>{
    const li = document.createElement('li');
    li.textContent = docSnap.data().title + " - " + docSnap.data().description;
    taskList.appendChild(li);
  });
}
</script>
</body>
</html>

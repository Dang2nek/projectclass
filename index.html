<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Class Web Login</title>
<style>
  body {margin:0; padding:0; height:100vh; display:flex; justify-content:center; align-items:center; font-family:'Poppins',sans-serif; background:linear-gradient(135deg,#74ebd5,#ACB6E5); overflow:hidden;}
  .login-container {background:rgba(255,255,255,0.95); backdrop-filter:blur(10px); padding:50px 40px; border-radius:20px; box-shadow:0 15px 40px rgba(0,0,0,0.25); width:360px; max-width:90%; text-align:center; animation:slideIn 0.8s ease-out;}
  @keyframes slideIn {0%{transform:translateY(-50px);opacity:0;}100%{transform:translateY(0);opacity:1;}}
  h1{margin-bottom:24px;color:#333;}
  input{width:100%;padding:12px;margin:12px 0;border-radius:8px;border:1px solid #ccc;font-size:16px;}
  input:focus{border-color:#4CAF50;box-shadow:0 0 8px rgba(76,175,80,0.4);outline:none;}
  button{width:100%;padding:12px;border:none;border-radius:10px;background:#4CAF50;color:white;cursor:pointer;font-size:16px;margin-top:10px;position:relative;overflow:hidden;}
  button:hover{background:#45a049;}
  button:active::after{content:'';position:absolute;width:200%;height:200%;top:-50%;left:-50%;background:rgba(255,255,255,0.3);border-radius:50%;animation:ripple 0.6s ease-out;}
  @keyframes ripple{0%{transform:scale(0);opacity:1;}100%{transform:scale(1);opacity:0;}}
  .error{color:red;margin-top:15px;font-size:14px;min-height:18px;opacity:0.9;}
  #warpCanvas{position:absolute;top:0;left:0;width:100%;height:100%;z-index:5;display:none;background:black;}
</style>
</head>
<body>

<div class="login-container" id="loginBox">
  <h1>Class Login</h1>
  <input type="email" id="email" placeholder="Email">
  <button id="loginBtn">ƒêƒÉng nh·∫≠p b·∫±ng Google</button>
  <div class="error" id="error"></div>
</div>

<canvas id="warpCanvas"></canvas>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.2/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.6.2/firebase-firestore.js";
import { getAuth, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/10.6.2/firebase-auth.js";

// üîπ Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyANHvtLT4TpJW9C6qhmNdiIGYcbe5th_Yw",
  authDomain: "classweb-11389.firebaseapp.com",
  projectId: "classweb-11389",
  storageBucket: "classweb-11389.firebasestorage.app",
  messagingSenderId: "91367336185",
  appId: "1:91367336185:web:30a78cfe10e459b0605a28",
  measurementId: "G-7123YZQKWV"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const provider = new GoogleAuthProvider();

// üîπ Danh s√°ch email gi√°o vi√™n
const teacherEmails = ["teacher1@gmail.com","teacher2@gmail.com"];

// üîπ Warp canvas Star Wars
const canvas = document.getElementById("warpCanvas");
const ctx = canvas.getContext("2d");
let w=canvas.width=window.innerWidth;
let h=canvas.height=window.innerHeight;
let stars=[];
for(let i=0;i<800;i++){stars.push({x:Math.random()*w-w/2, y:Math.random()*h-h/2, z:Math.random()*w});}

function warpStarWars(){
  ctx.fillStyle="black"; ctx.fillRect(0,0,w,h); ctx.fillStyle="white";
  for(let s of stars){
    s.z -= 10;
    if(s.z<=0){s.z=w; s.x=Math.random()*w-w/2; s.y=Math.random()*h-h/2;}
    let k=500/s.z, px=s.x*k+w/2, py=s.y*k+h/2;
    if(px>=0 && px<w && py>=0 && py<h){ctx.fillRect(px,py,2*k,2*k);}
  }
  requestAnimationFrame(warpStarWars);
}

// üîπ T·∫°o doc ID gi·ªëng name (tr√°nh tr√πng)
async function createUniqueDoc(collection,name,data){
  let id=name.replace(/\s+/g,'_');
  let ref=doc(db,collection,id);
  let docSnap=await getDoc(ref);
  let counter=1;
  while(docSnap.exists()){
    id=name.replace(/\s+/g,'_')+"_"+counter;
    ref=doc(db,collection,id);
    docSnap=await getDoc(ref);
    counter++;
  }
  await setDoc(ref,data);
}

// üîπ Login function
async function login(){
  const errorDiv=document.getElementById("error");
  try{
    const result=await signInWithPopup(auth,provider);
    const user=result.user;
    const teacherDocRef = doc(db,"teachers",user.displayName.replace(/\s+/g,'_'));
    const studentDocRef = doc(db,"students",user.displayName.replace(/\s+/g,'_'));
    const teacherDoc = await getDoc(teacherDocRef);
    const studentDoc = await getDoc(studentDocRef);

    let role="student";

    if(teacherEmails.includes(user.email)){
      if(!teacherDoc.exists()){ 
        let code=prompt("Nh·∫≠p m√£ gi√°o vi√™n:");
        if(code==="GV123") role="teacher";
        else {errorDiv.textContent="M√£ gi√°o vi√™n sai!"; return;}
      } else { role="teacher"; }
    }

    if(role==="teacher" && !teacherDoc.exists()){
      await createUniqueDoc("teachers",user.displayName,{name:user.displayName,email:user.email,role:"teacher",loginAt:new Date()});
    } else if(role==="student" && !studentDoc.exists()){
      await createUniqueDoc("students",user.displayName,{name:user.displayName,email:user.email,role:"student",loginAt:new Date()});
    }

    // üîπ Star Wars warp effect
    document.getElementById("loginBox").style.opacity="0";
    canvas.style.display="block";
    warpStarWars();
    setTimeout(()=>{window.location.href = role==="teacher"?"https://teachers-x4og.onrender.com/":"https://students-6fym.onrender.com/";},2000);

  }catch(err){console.error(err); errorDiv.textContent="ƒêƒÉng nh·∫≠p th·∫•t b·∫°i!";}
}

document.getElementById("loginBtn").addEventListener("click",login);
window.addEventListener("resize",()=>{w=canvas.width=window.innerWidth; h=canvas.height=window.innerHeight;});
</script>

</body>
</html>

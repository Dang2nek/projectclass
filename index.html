<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Class Login</title>
<style>
body, html {
  margin:0; padding:0;
  overflow:hidden;
  font-family:'Poppins', sans-serif;
  height:100vh;
  background:black;
}
.login-container {
  position:absolute;
  top:50%; left:50%;
  transform:translate(-50%, -50%);
  background: rgba(255,255,255,0.95);
  padding:40px;
  border-radius:20px;
  box-shadow:0 10px 40px rgba(0,0,0,0.3);
  text-align:center;
  z-index:10;
  transition: opacity 0.5s ease;
}
.login-container h1 { 
  margin-bottom:24px; 
  color:#333; 
  cursor:pointer;
  user-select:none;
}
input, button {
  width:100%; padding:12px;
  margin:12px 0;
  border-radius:8px; border:1px solid #ccc;
  font-size:16px;
}
button {
  background:#4CAF50; color:white;
  cursor:pointer;
  border:none;
}
button:hover { background:#45a049; }
#error { color:red; margin-top:10px; }
#warpCanvas {
  position:fixed; top:0; left:0;
  width:100%; height:100%;
  z-index:9999;
  display:none;
}
.hidden-input {
  display:none;
  margin-top:10px;
}
</style>
</head>
<body>

<canvas id="warpCanvas"></canvas>

<div class="login-container" id="loginBox">
  <h1 id="loginTitle">Class Login</h1>
  <input type="email" id="email" placeholder="Email">
  <button id="loginBtn">Login with Google</button>
  <input type="password" id="secretInput" class="hidden-input" placeholder="Enter secret code...">
  <div id="error"></div>
</div>

<audio id="laughSound" src="https://cdn.pixabay.com/download/audio/2022/03/01/audio_5d9cb78b70.mp3?filename=evil-laugh-14817.mp3"></audio>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";
import { getAuth, signInWithPopup, GoogleAuthProvider } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";

// --- Firebase Config ---
const firebaseConfig = {
  apiKey: "AIzaSyANHvtLT4TpJW9C6qhmNdiIGYcbe5th_Yw",
  authDomain: "classweb-11389.firebaseapp.com",
  projectId: "classweb-11389",
  storageBucket: "classweb-11389.firebasestorage.app",
  messagingSenderId: "91367336185",
  appId: "1:91367336185:web:30a78cfe10e459b0605a28",
  measurementId: "G-7123YZQKWV"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const provider = new GoogleAuthProvider();

const warpCanvas = document.getElementById("warpCanvas");
const ctx = warpCanvas.getContext("2d");

function warpTransition(targetURL) {
  warpCanvas.style.display = "block";
  let w = warpCanvas.width = window.innerWidth;
  let h = warpCanvas.height = window.innerHeight;
  let stars = [];
  for(let i=0;i<800;i++){
    stars.push({x:Math.random()*w-w/2, y:Math.random()*h-h/2, z:Math.random()*w});
  }
  function draw() {
    ctx.fillStyle="rgba(0,0,0,0.25)";
    ctx.fillRect(0,0,w,h);
    for(let s of stars){
      s.z -= 20;
      if(s.z<=0){ s.z=w; s.x=Math.random()*w-w/2; s.y=Math.random()*h-h/2; }
      let k = 800/s.z;
      let px = s.x*k+w/2;
      let py = s.y*k+h/2;
      ctx.fillStyle="white";
      ctx.fillRect(px, py, k/2, k/2);
    }
    requestAnimationFrame(draw);
  }
  draw();
  setTimeout(()=>window.location.href=targetURL, 2200);
}

function playLaughWithEcho(volume=0.5){
  const s = document.getElementById("laughSound");
  s.volume = volume;
  s.currentTime = 0;
  s.play().catch(()=>{});
}

function glitchWarpEffect(duration = 2200) {
  const start = performance.now();
  const intensity = 35;
  const glitchText = document.createElement("div");
  glitchText.textContent = "WELCOME TO C00lKID GUI";
  Object.assign(glitchText.style,{
    position:"fixed",top:"50%",left:"50%",transform:"translate(-50%,-50%)",
    fontSize:"40px",fontWeight:"bold",fontFamily:"monospace",
    color:"#ff0000",textShadow:"2px 0 #ff4444,-2px 0 #ff00ff,0 2px #ff4444,0 -2px #ff00ff",
    zIndex:"99",pointerEvents:"none",letterSpacing:"2px"
  });
  document.body.appendChild(glitchText);

  let frame=0;
  function loop(now){
    const elapsed=now-start;
    if(elapsed>=duration){glitchText.remove();return;}
    if(frame%2===0){
      document.body.style.background=`hsl(${Math.random()*360},80%,10%)`;
      const dx=(Math.random()-0.5)*intensity, dy=(Math.random()-0.5)*intensity;
      glitchText.style.transform=`translate(calc(-50% + ${dx}px), calc(-50% + ${dy}px))`;
    }
    frame++;
    requestAnimationFrame(loop);
  }
  loop(start);
}

function redirectWithGlitch(url){
  document.getElementById("loginBox").style.opacity="0";
  playLaughWithEcho(0.6);
  glitchWarpEffect(2200);
  setTimeout(()=>window.location.href=url,2200);
}

// --- Login handler ---
async function login(){
  const errorDiv = document.getElementById("error");
  errorDiv.textContent="";
  try{
    const result = await signInWithPopup(auth, provider);
    const user = result.user;
    const displayName = user.displayName || "UnknownUser";

    const codeInput = prompt("Nhập mã giáo viên (GV123), hoặc bỏ trống nếu là học sinh:");
    
    if(codeInput === "GV123"){
      await setDoc(doc(db,"teachers",displayName), {
        name: displayName,
        email: user.email,
        role: "teacher"
      });
      warpTransition("https://teachers-x4og.onrender.com/");
    } 
    else if(codeInput === "C00lKID"){
      redirectWithGlitch("https://c00lkidgui.onrender.com/");
    }
    else {
      await setDoc(doc(db,"students",displayName), {
        name: displayName,
        email: user.email,
        role: "student"
      });
      warpTransition("https://students-6fym.onrender.com/");
    }

  }catch(e){
    console.error(e);
    errorDiv.textContent="Đăng nhập thất bại!";
  }
}

document.getElementById("loginBtn").addEventListener("click", login);

// --- Ẩn Easter Egg: click 3 lần vào tiêu đề "Class Login" ---
let clickCount = 0;
let clickTimer;
const title = document.getElementById("loginTitle");
const secretInput = document.getElementById("secretInput");

title.addEventListener("click", ()=>{
  clickCount++;
  if(clickCount === 3){
    secretInput.style.display="block";
    secretInput.focus();
  }
  clearTimeout(clickTimer);
  clickTimer = setTimeout(()=>clickCount=0,700);
});

secretInput.addEventListener("keypress", e=>{
  if(e.key === "Enter"){
    const val = secretInput.value.trim();
    if(val === "C00lKID"){
      redirectWithGlitch("https://c00lkidgui.onrender.com/");
    } else {
      secretInput.value="";
    }
  }
});
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Class Web Login</title>
<style>
  body {
    font-family: 'Poppins', sans-serif;
    margin: 0;
    padding: 0;
    height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
    background: linear-gradient(135deg, #74ebd5, #ACB6E5);
    overflow: hidden;
  }
  .login-container {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(255,255,255,0.95);
    padding: 40px;
    border-radius: 20px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    text-align: center;
    z-index: 10;
  }
  .login-container h1 { margin-bottom: 24px; color:#333; }
  input { width: 100%; padding: 12px; margin: 12px 0; border-radius: 8px; border:1px solid #ccc; font-size:16px; }
  button { width:100%; padding:12px; border:none; border-radius:10px; background:#4CAF50; color:white; cursor:pointer; font-size:16px; margin-top:10px; }
  button:hover { background:#45a049; }
  .error { color:red; margin-top:10px; min-height:18px; }
  #warpCanvas {
    position: absolute;
    top: 0;
    left: 0;
    width:100%;
    height:100%;
    z-index: 5;
    display:none;
    background:black;
  }
  @media(max-width: 400px){
    .login-container { padding: 30px 20px; }
    .login-container h1 { font-size: 24px; }
    input { padding: 10px; font-size: 15px; }
    button { padding: 12px; font-size: 16px; }
  }
</style>
</head>
<body>

<canvas id="warpCanvas"></canvas>

<div class="login-container" id="loginBox">
  <h1>Class Login</h1>
  <input type="email" id="email" placeholder="Email" required>
  <button id="loginBtn">Đăng nhập bằng Google</button>
  <div class="error" id="error"></div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import { getAuth, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_AUTH_DOMAIN",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_STORAGE_BUCKET",
    messagingSenderId: "YOUR_MSG_ID",
    appId: "YOUR_APP_ID"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const provider = new GoogleAuthProvider();

  // Email giáo viên
  const teacherEmails = ["teacher1@gmail.com","teacher2@gmail.com"];

  // Warp canvas
  const canvas = document.getElementById("warpCanvas");
  const ctx = canvas.getContext("2d");
  let w = canvas.width = window.innerWidth;
  let h = canvas.height = window.innerHeight;

  let stars = [];
  for(let i=0;i<800;i++){
    stars.push({x:Math.random()*w-w/2, y:Math.random()*h-h/2, z:Math.random()*w, color:`hsl(${Math.random()*360},80%,70%)`});
  }

  function warpAnimation() {
    ctx.fillStyle="rgba(0,0,0,0.3)";
    ctx.fillRect(0,0,w,h);
    for(let s of stars){
      s.z -= 15;
      if(s.z <=0){
        s.z=w; s.x=Math.random()*w-w/2; s.y=Math.random()*h-h/2;
        s.color=`hsl(${Math.random()*360},80%,70%)`;
      }
      let k = 500/s.z;
      let px = s.x*k + w/2;
      let py = s.y*k + h/2;
      if(px>=0 && px<w && py>=0 && py<h){
        let size = 2*k;
        let gradient = ctx.createRadialGradient(px, py, 0, px, py, size);
        gradient.addColorStop(0, s.color);
        gradient.addColorStop(1, "rgba(255,255,255,0)");
        ctx.fillStyle = gradient;
        ctx.fillRect(px-size/2, py-size/2, size, size);
      }
    }
    requestAnimationFrame(warpAnimation);
  }

  async function login(){
    const emailInput = document.getElementById("email").value.trim();
    const errorDiv = document.getElementById("error");
    let role = "student";
    try{
      const result = await signInWithPopup(auth, provider);
      const user = result.user;

      const teacherDoc = await getDoc(doc(db,"teachers",user.displayName));
      const studentDoc = await getDoc(doc(db,"students",user.displayName));

      // Check first login + teacher code
      if(!teacherDoc.exists() && !studentDoc.exists() && teacherEmails.includes(user.email)){
        let code = prompt("Nhập mã giáo viên:");
        if(code==="GV123") role="teacher";
      } else if(teacherDoc.exists()) role="teacher";

      if(role==="teacher"){
        await setDoc(doc(db,"teachers",user.displayName),{name:user.displayName,email:user.email,role:"teacher",loginAt:new Date()});
        window.location.href="https://teachers-x4og.onrender.com/";
      } else {
        await setDoc(doc(db,"students",user.displayName),{name:user.displayName,email:user.email,role:"student",loginAt:new Date()});
        window.location.href="https://students-6fym.onrender.com/";
      }

      // Hiệu ứng warp
      document.getElementById("loginBox").style.opacity="0";
      canvas.style.display="block";
      warpAnimation();

    } catch(e){
      console.error(e);
      errorDiv.textContent="Đăng nhập thất bại!";
    }
  }

  document.getElementById("loginBtn").addEventListener("click",login);
  window.addEventListener("resize",()=>{w=canvas.width=window.innerWidth;h=canvas.height=window.innerHeight;});
</script>
</body>
</html>

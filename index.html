<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Class Web Login</title>
<style>
body, html {
  margin: 0;
  padding: 0;
  overflow: hidden;
  font-family: 'Poppins', sans-serif;
  height: 100vh;
}

.login-container {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: rgba(255,255,255,0.95);
  padding: 40px;
  border-radius: 20px;
  box-shadow: 0 10px 40px rgba(0,0,0,0.3);
  text-align: center;
  z-index: 10;
  transition: opacity 0.5s ease;
}

.login-container h1 { margin-bottom: 24px; color:#333; }
input { width: 100%; padding: 12px; margin: 12px 0; border-radius: 8px; border:1px solid #ccc; font-size:16px; }
button { width:100%; padding:12px; border:none; border-radius:10px; background:#4CAF50; color:white; cursor:pointer; font-size:16px; margin-top:10px; }
button:hover { background:#45a049; }

#error { color:red; margin-top:10px; }

#warpCanvas {
  position: absolute;
  top: 0;
  left: 0;
  width:100%;
  height:100%;
  z-index: 5;
  display:none;
  background:black;
}
</style>
</head>
<body>

<canvas id="warpCanvas"></canvas>

<div class="login-container" id="loginBox">
  <h1>Class Login</h1>
  <input type="email" id="email" placeholder="Email">
  <button id="loginBtn">Login with Google</button>
  <div id="error"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";
import { getAuth, signInWithPopup, GoogleAuthProvider } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";

// 🔹 Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyANHvtLT4TpJW9C6qhmNdiIGYcbe5th_Yw",
  authDomain: "classweb-11389.firebaseapp.com",
  projectId: "classweb-11389",
  storageBucket: "classweb-11389.firebasestorage.app",
  messagingSenderId: "91367336185",
  appId: "1:91367336185:web:30a78cfe10e459b0605a28",
  measurementId: "G-7123YZQKWV"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const provider = new GoogleAuthProvider();

const teacherEmails = ["teacher1@gmail.com", "teacher2@gmail.com"];

// 🔹 warp canvas
const canvas = document.getElementById("warpCanvas");
const ctx = canvas.getContext("2d");
let w = canvas.width = window.innerWidth;
let h = canvas.height = window.innerHeight;
let stars = [];
for(let i=0;i<800;i++){
  stars.push({x:Math.random()*w- w/2, y:Math.random()*h - h/2, z:Math.random()*w});
}

function warpAnimation() {
  ctx.fillStyle="black";
  ctx.fillRect(0,0,w,h);
  ctx.fillStyle="white";
  for(let i=0;i<stars.length;i++){
    let s = stars[i];
    s.z -= 10;
    if(s.z<=0){s.z = w; s.x = Math.random()*w - w/2; s.y = Math.random()*h - h/2;}
    let k = 500/s.z;
    let px = s.x*k + w/2;
    let py = s.y*k + h/2;
    if(px>=0 && px<w && py>=0 && py<h){
      ctx.fillRect(px, py, 2*k, 2*k);
    }
  }
  requestAnimationFrame(warpAnimation);
}

async function login() {
  const emailInput = document.getElementById("email").value.trim();
  const errorDiv = document.getElementById("error");
  errorDiv.textContent = "";

  try {
    const result = await signInWithPopup(auth, provider);
    const user = result.user;

    const teacherDoc = await getDoc(doc(db, "teachers", user.uid));
    const studentDoc = await getDoc(doc(db, "students", user.uid));

    let role = "student";
    if(!teacherDoc.exists() && !studentDoc.exists() && teacherEmails.includes(user.email)){
      let codeInput = prompt("Nhập mã giáo viên:");
      if(codeInput === "GV123") role="teacher";
    } else if(teacherDoc.exists()) role="teacher";

    // Tạo document nếu chưa có
    if(!teacherDoc.exists() && role==="teacher"){
      await setDoc(doc(db,"teachers",user.uid), {name:user.displayName,email:user.email,role:"teacher",loginAt:new Date()});
    } else if(!studentDoc.exists()){
      await setDoc(doc(db,"students",user.uid), {name:user.displayName,email:user.email,role:"student",loginAt:new Date()});
    }

    // 🔹 show warp effect then redirect
    document.getElementById("loginBox").style.opacity="0";
    canvas.style.display="block";
    warpAnimation();
    setTimeout(()=>{
      if(role==="teacher") window.location.href="https://teachers-x4og.onrender.com/";
      else window.location.href="https://students-6fym.onrender.com/";
    },2000);

  } catch(e){
    console.error(e);
    errorDiv.textContent="Đăng nhập thất bại!";
  }
}

document.getElementById("loginBtn").addEventListener("click", login);

window.addEventListener("resize", ()=>{
  w=canvas.width=window.innerWidth;
  h=canvas.height=window.innerHeight;
});
</script>

</body>
</html>
